# Reverse Verification Tool - Knowledge Rules & Guidelines

**Purpose:** Establish clear rules and guidelines so every team member understands the project architecture, deployment process, and best practices without needing to ask repeatedly.

---

## Rule 1: Project Architecture

### What You Must Know
- **This is a full-stack Encore application**, not a standalone frontend
- **Backend and frontend are tightly coupled** via the `~backend` alias
- **Frontend cannot be deployed separately** (e.g., to GitHub Pages)
- **Both must be deployed together** to Encore

### What This Means
- ❌ DO NOT try to deploy frontend independently
- ❌ DO NOT remove backend imports from frontend
- ✅ DO deploy entire project to Encore
- ✅ DO treat backend and frontend as one unit

### Reference
See: `PROJECT_ARCHITECTURE_REPORT.md` → Architecture Overview

---

## Rule 2: Deployment Pipeline

### The Flow (Every Time)
```
Your Code Changes
       ↓
git push origin main
       ↓
GitHub Actions Workflows Run
       ↓
Encore Auto-Deploys
       ↓
Live at https://reverse-verification-tool-i452-staging.encr.app
```

### What You Must Do
1. **Always push to GitHub** - Never deploy directly to Encore
2. **Check GitHub Actions** after every push - Verify build succeeded
3. **Check Encore dashboard** - Confirm deployment completed
4. **Test on staging** - Before considering it done

### What You Must NOT Do
- ❌ DO NOT push directly to Encore
- ❌ DO NOT skip GitHub Actions checks
- ❌ DO NOT deploy to production without testing staging first
- ❌ DO NOT commit secrets to GitHub

### Reference
See: `PROJECT_ARCHITECTURE_REPORT.md` → Deployment Flow

---

## Rule 3: File Organization

### Backend Files (`/backend/verification/`)
**Rule:** Each file represents one Encore service

| File | Purpose | Who Edits |
|------|---------|-----------|
| `verify.ts` | Core verification | Backend Dev |
| `device_fingerprinting.ts` | Device identification | Backend Dev |
| `trust_scoring.ts` | Trust calculation | Backend Dev |
| `badge_lifecycle.ts` | Badge management | Backend Dev |
| `blockchain.ts` | Blockchain integration | Backend Dev |
| `zkp_verification.ts` | Zero-knowledge proofs | Backend Dev |
| `marketplace_sdk.ts` | Marketplace integration | Backend Dev |
| `partner_api.ts` | Partner endpoints | Backend Dev |

**Rule:** Each service file must export Encore endpoints using decorators

### Frontend Files (`/frontend/`)
**Rule:** Organized by feature/page

| Directory | Purpose | Who Edits |
|-----------|---------|-----------|
| `/pages/` | Page-level components | Frontend Dev |
| `/components/` | Reusable UI components | Frontend Dev |
| `/lib/` | Utility functions | Frontend Dev |
| `/hooks/` | Custom React hooks | Frontend Dev |
| `client.ts` | Auto-generated API client | DO NOT EDIT |
| `App.tsx` | Router & layout | Frontend Dev |

**Rule:** `client.ts` is auto-generated by Encore - never edit it manually

### Configuration Files (Root)
**Rule:** These control the entire deployment

| File | Purpose | Who Edits |
|------|---------|-----------|
| `encore.app` | Encore configuration | DevOps only |
| `.github/workflows/` | CI/CD automation | DevOps only |
| `frontend/.env.development` | Local dev config | All (read-only) |
| `frontend/.env.production` | Production config | DevOps only |

**Rule:** Never modify workflow files or Encore config without team discussion

---

## Rule 4: Environment Variables

### Development (Local Machine)
**File:** `frontend/.env.development`
```
VITE_CLIENT_TARGET=http://localhost:4000
```

**How to use:**
```bash
cd backend
encore run  # Starts backend on localhost:4000

# In another terminal
cd frontend
bun run dev  # Starts frontend on localhost:5173
```

### Production (Encore Cloud)
**File:** `frontend/.env.production`
```
VITE_CLIENT_TARGET=http://localhost:4000
```

**How it works:**
- Encore automatically resolves the correct backend URL during deployment
- You don't need to change this file
- Secrets are managed in Encore dashboard

### Secrets Management
**Rule:** Never commit secrets to GitHub

**Where to store:**
1. **Local development:** Use `.env.local` (gitignored)
2. **Production:** Use Encore dashboard → Settings → Secrets

**How to access:**
- Encore: https://app.encore.cloud/reverse-verification-tool-i452/settings/secrets
- GitHub: Settings → Secrets and variables

**Rule:** If you need a new secret:
1. Add it to Encore dashboard
2. Reference it in code as `process.env.SECRET_NAME`
3. Notify the team

---

## Rule 5: Git Workflow

### Before Pushing
```bash
# 1. Make your changes
# 2. Test locally
bun run check  # Type checking
bun run build  # Build verification
bun run test   # Run tests (if available)

# 3. Commit with clear message
git commit -m "feat: Add new verification feature"

# 4. Push
git push origin main
```

### Commit Message Format
```
<type>: <description>

<optional body explaining why>

Example:
feat: Add zero-knowledge proof verification
- Implements ZKP for anonymous device verification
- Reduces verification time by 40%
- Adds new endpoint: POST /verify/zkp
```

**Types:**
- `feat:` New feature
- `fix:` Bug fix
- `refactor:` Code restructuring
- `docs:` Documentation
- `test:` Test additions
- `chore:` Build/tooling changes

### After Pushing
1. **Check GitHub Actions:** https://github.com/kudzimusar/reverse-verification-tool/actions
2. **Wait for build to complete** (usually 2-3 minutes)
3. **Check Encore deployment:** https://app.encore.cloud/reverse-verification-tool-i452
4. **Test on staging:** https://reverse-verification-tool-i452-staging.encr.app

**Rule:** If build fails:
- Check GitHub Actions logs
- Fix the issue locally
- Commit and push again
- Don't try to fix directly on Encore

---

## Rule 6: Local Development Setup

### First Time Setup
```bash
# Clone repository
git clone https://github.com/kudzimusar/reverse-verification-tool.git
cd reverse-verification-tool

# Install Encore CLI
curl -L https://encore.dev/install.sh | bash

# Install dependencies
cd backend && bun install
cd ../frontend && bun install
```

### Running Locally
```bash
# Terminal 1: Start backend
cd backend
encore run
# Backend runs on http://localhost:4000

# Terminal 2: Start frontend
cd frontend
bun run dev
# Frontend runs on http://localhost:5173
```

### Stopping
```bash
# Press Ctrl+C in each terminal
```

### Troubleshooting
- **Port already in use:** Kill process or use different port
- **Dependencies not installing:** Delete `node_modules` and `bun.lockb`, then reinstall
- **TypeScript errors:** Run `bun run check` to see full errors
- **Build fails:** Check Node.js version (should be 18+)

---

## Rule 7: Code Quality Standards

### TypeScript
**Rule:** All code must be type-safe

```typescript
// ✅ Good
function verifyDevice(serialNumber: string): Promise<VerificationResult> {
  // ...
}

// ❌ Bad
function verifyDevice(serialNumber) {
  // ...
}
```

### Testing
**Rule:** New features should include tests

```bash
# Run tests
bun run test

# Run tests in watch mode
bun run test:watch
```

### Linting
**Rule:** Code must pass linting

```bash
# Check linting
bun run lint

# Fix linting issues
bun run lint:fix
```

### Type Checking
**Rule:** No TypeScript errors before pushing

```bash
# Check types
bun run check
```

---

## Rule 8: Backend Development

### Creating New Endpoints
**Rule:** Use Encore service syntax

```typescript
// File: backend/verification/new_feature.ts
import { api } from "encore.dev/api";

export const newFeature = api(
  { method: "POST", path: "/verify/new-feature" },
  async (req: NewFeatureRequest): Promise<NewFeatureResponse> => {
    // Implementation
    return { success: true };
  }
);
```

### Database Access
**Rule:** Use Drizzle ORM through Encore's database integration

```typescript
// Database queries go through Encore's managed connection
import { db } from "./db";

const result = await db.query.devices.findFirst({
  where: (devices, { eq }) => eq(devices.serialNumber, serialNumber),
});
```

### Error Handling
**Rule:** Return proper HTTP status codes

```typescript
// ✅ Good
throw new Error("Device not found"); // Returns 400
throw new Error("Unauthorized"); // Returns 401

// ❌ Bad
return { error: "Device not found" }; // Returns 200 (wrong!)
```

---

## Rule 9: Frontend Development

### Component Structure
**Rule:** Keep components small and focused

```typescript
// ✅ Good - Single responsibility
export function DeviceVerificationForm() {
  // Form logic only
}

export function VerificationResult() {
  // Result display only
}

// ❌ Bad - Too much responsibility
export function VerificationPage() {
  // Form + result + analytics + everything
}
```

### API Calls
**Rule:** Use the auto-generated client

```typescript
// ✅ Good - Use generated client
import client from "@/client";

const result = await client.verification.verify({
  serialNumber: "ABC123",
});

// ❌ Bad - Direct fetch calls
const result = await fetch("/api/verify", { /* ... */ });
```

### State Management
**Rule:** Use React hooks for local state, context for shared state

```typescript
// ✅ Good - Local state
const [isLoading, setIsLoading] = useState(false);

// ✅ Good - Shared state via context
const { user } = useAuth();

// ❌ Bad - Global state library without justification
```

---

## Rule 10: Deployment Checklist

### Before Pushing to Main
- [ ] Code tested locally
- [ ] No TypeScript errors (`bun run check`)
- [ ] Linting passes (`bun run lint`)
- [ ] Tests pass (`bun run test`)
- [ ] Commit message is clear
- [ ] No secrets in code

### After Pushing
- [ ] GitHub Actions workflow completes
- [ ] Encore deployment succeeds
- [ ] Staging URL is accessible
- [ ] Basic functionality works on staging
- [ ] No errors in browser console

### Before Production Deploy
- [ ] Thoroughly tested on staging
- [ ] Team approval obtained
- [ ] Database migrations tested
- [ ] Rollback plan prepared
- [ ] Monitoring configured

---

## Rule 11: Communication & Documentation

### When You Make Changes
1. **Update commit message** - Explain what and why
2. **Update relevant docs** - If architecture changes
3. **Notify team** - If it affects others
4. **Add comments** - For complex logic

### When You're Stuck
1. **Check PROJECT_ARCHITECTURE_REPORT.md** first
2. **Check GitHub Actions logs** for errors
3. **Check Encore dashboard** for deployment status
4. **Ask team** with specific error message

### When You Find Issues
1. **Document the issue** clearly
2. **Create GitHub issue** if it's a bug
3. **Notify team** if it blocks deployment
4. **Propose solution** if possible

---

## Rule 12: Related Projects

### PayPass (Separate Project)
**Important:** This is a DIFFERENT project

- **Deployment:** Vercel (not Encore)
- **URL:** https://paypass.website
- **Status:** Independent
- **Interaction:** None with reverse-verification-tool

**Rule:** Do NOT confuse the two projects

---

## Quick Reference

### URLs
- **Staging:** https://reverse-verification-tool-i452-staging.encr.app
- **Production:** https://reverse-verification-tool-i452.encr.app
- **Dashboard:** https://app.encore.cloud/reverse-verification-tool-i452
- **GitHub:** https://github.com/kudzimusar/reverse-verification-tool
- **Actions:** https://github.com/kudzimusar/reverse-verification-tool/actions

### Commands
```bash
# Local development
encore run                    # Start backend
bun run dev                   # Start frontend (in another terminal)

# Testing & checking
bun run check                 # Type checking
bun run lint                  # Linting
bun run test                  # Tests
bun run build                 # Build verification

# Deployment
git push origin main          # Triggers GitHub Actions & Encore deployment
```

### Files to Know
- `PROJECT_ARCHITECTURE_REPORT.md` - Full architecture explanation
- `KNOWLEDGE_RULES.md` - This file (team guidelines)
- `encore.app` - Encore configuration
- `.github/workflows/` - CI/CD workflows
- `frontend/.env.development` - Local dev config
- `backend/verification/` - Backend services
- `frontend/pages/` - Frontend pages

---

## Onboarding Checklist

New team members should:
- [ ] Read `PROJECT_ARCHITECTURE_REPORT.md`
- [ ] Read `KNOWLEDGE_RULES.md` (this file)
- [ ] Clone repository locally
- [ ] Run `encore run` and `bun run dev`
- [ ] Access staging URL
- [ ] Make a test commit and push
- [ ] Verify GitHub Actions runs
- [ ] Verify Encore deploys
- [ ] Ask questions if anything is unclear

---

## Questions?

If you have questions not answered here:
1. Check `PROJECT_ARCHITECTURE_REPORT.md`
2. Check GitHub Actions logs
3. Check Encore dashboard
4. Ask the team

**Remember:** It's better to ask than to break the build!

---

**Last Updated:** January 18, 2026  
**Version:** 1.0  
**Status:** Active
